<!DOCTYPE html>
<html lang="ja" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- タイトルを v4.4 に更新 -->
    <title>Easy Discord Bot Builder v4.4</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='4' y='4' width='56' height='56' rx='16' fill='%234f46e5' /%3E%3Ccircle cx='22' cy='26' r='6' fill='white' /%3E%3Ccircle cx='42' cy='26' r='6' fill='white' /%3E%3Cpath d='M20 42 Q32 52 44 42' stroke='white' stroke-width='4' fill='none' stroke-linecap='round' /%3E%3C/svg%3E">\r\n
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748',
                            850: '#1a202c',
                        },
                        indigo: {
                            650: '#4f46e5',
                        },
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            transition: background-color 0.3s;
        }
        .dark body {
            background-color: #1a202c;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.2s ease-out;
        }
        .show-modal {
            opacity: 1;
        }
        .show-modal .modal-content {
            transform: scale(1);
        }
        /* Custom scrollbar for text areas */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-track {
            background-color: #f3f4f6;
        }
        .dark textarea::-webkit-scrollbar-thumb {
            background-color: #4a5568;
        }
        .dark textarea::-webkit-scrollbar-track {
            background-color: #2d3748;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen p-4 sm:p-8">

    <!-- Main Container -->
    <div class="max-w-4xl mx-auto">
        
        <!-- Header -->
        <header class="mb-8 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64' class="w-8 h-8 md:w-10 md:h-10">
                    <rect x='4' y='4' width='56' height='56' rx='16' fill='#4f46e5' />
                    <circle cx='22' cy='26' r='6' fill='white' />
                    <circle cx='42' cy='26' r='6' fill='white' />
                    <path d='M20 42 Q32 52 44 42' stroke='white' stroke-width='4' fill='none' stroke-linecap='round' />
                </svg>
                <!-- バージョンを v4.4 に更新 -->
                <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-600 dark:text-indigo-400">Easy Discord Bot Builder <span class="text-xl text-gray-500 dark:text-gray-400">v4.4</span></h1>
            </div>
            <button id="themeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-150">
                <i data-lucide="sun" id="sunIcon" class="w-5 h-5 text-yellow-500"></i>
                <i data-lucide="moon" id="moonIcon" class="w-5 h-5 text-gray-300 hidden"></i>
            </button>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Input / Settings Card -->
            <div class="lg:col-span-2 card bg-white dark:bg-gray-800 p-6 rounded-xl space-y-6">
                <h2 class="text-2xl font-semibold border-b pb-3 mb-4 text-indigo-600 dark:border-gray-700 dark:text-indigo-400">ボット設定</h2>

                <!-- Project Name -->
                <div>
                    <label for="projectName" class="block text-sm font-medium mb-1">プロジェクト名</label>
                    <input type="text" id="projectName" value="BotProject" placeholder="プロジェクト名を入力"
                        class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-750 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <!-- Bot Token -->
                <div>
                    <label for="botToken" class="block text-sm font-medium mb-1 flex justify-between items-center">
                        <span>Discord Bot Token <span class="text-red-500">*必須</span></span>
                        <a href="https://discord.com/developers/applications" target="_blank" rel="noopener noreferrer" class="text-xs text-indigo-500 hover:text-indigo-400 flex items-center space-x-1">
                            <i data-lucide="external-link" class="w-3 h-3"></i>
                            <span>開発者ポータル</span>
                        </a>
                    </label>
                    <input type="text" id="botToken" placeholder="YOUR_BOT_TOKEN_HERE"
                        class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-750 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <!-- Intents -->
                <div>
                    <label class="block text-sm font-medium mb-2">インテント設定 <span class="text-xs text-gray-500 dark:text-gray-400">(必要なものにチェック)</span></label>
                    <div id="intentsContainer" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <!-- Intents will be populated here -->
                    </div>
                </div>

                <!-- Command Definitions (Simple) -->
                <div>
                    <label class="block text-sm font-medium mb-2">スラッシュコマンド定義 (簡易)</label>
                    <div id="commandsContainer" class="space-y-3">
                        <!-- Command inputs will be added here -->
                    </div>
                    <button id="addCommandBtn" class="mt-3 w-full py-2 px-4 border border-indigo-500 text-indigo-600 dark:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-gray-700 transition duration-150 flex items-center justify-center space-x-2">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>コマンドを追加</span>
                    </button>
                </div>
            </div>

            <!-- Output / Info Card -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Actions -->
                <div class="card bg-white dark:bg-gray-800 p-6 rounded-xl space-y-4">
                    <h2 class="text-xl font-semibold text-indigo-600 dark:text-indigo-400">アクション</h2>
                    <button id="showCodeBtn" class="w-full py-3 px-4 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-lg shadow-indigo-500/50 flex items-center justify-center space-x-2">
                        <i data-lucide="code" class="w-5 h-5"></i>
                        <span>Pythonコードを表示</span>
                    </button>
                    <button id="downloadXMLBtn" class="w-full py-3 px-4 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition duration-150 shadow-lg shadow-gray-500/50 flex items-center justify-center space-x-2">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        <span>XMLファイルダウンロード (Bot Designer For Discord形式)</span>
                    </button>
                </div>

                <!-- Info / Help -->
                <div class="card bg-white dark:bg-gray-800 p-6 rounded-xl space-y-4">
                    <h2 class="text-xl font-semibold text-indigo-600 dark:text-indigo-400">ヘルプとドキュメント</h2>
                    <p class="text-sm">このツールは、Discord.py (Nextcord互換) を使用したシンプルなDiscordボットのセットアップを支援します。</p>
                    <a id="docsLink" href="https://github.com/himais0giiiin/easy-bdc/wiki/Docs" target="_blank" rel="noopener noreferrer" 
                       class="w-full py-2 px-4 border border-indigo-500 text-indigo-600 dark:text-indigo-400 rounded-lg hover:bg-indigo-50 dark:hover:bg-gray-700 transition duration-150 flex items-center justify-center space-x-2 text-sm font-medium">
                        <i data-lucide="book-open" class="w-4 h-4"></i>
                        <!-- ドキュメント URL を更新 -->
                        <span>公式ドキュメントを見る</span>
                    </a>
                    <div class="flex items-start space-x-2 text-sm pt-2 border-t dark:border-gray-700">
                        <i data-lucide="alert-triangle" class="w-4 h-4 text-yellow-500 flex-shrink-0 mt-1"></i>
                        <p class="text-gray-700 dark:text-gray-300">
                            **注意:** トークンは秘密情報です。生成されたコードを公開リポジトリに直接コミットしないでください。環境変数を使用することを強く推奨します。
                        </p>
                    </div>
                </div>
            </div>

        </div>

        <!-- Footer -->
        <footer class="mt-10 text-center text-sm text-gray-500 dark:text-gray-400">
            &copy; 2024 Easy Discord Bot Builder. | Powered by <a href="https://github.com/himais0giiiin/easy-bdc" target="_blank" rel="noopener noreferrer" class="text-indigo-500 hover:text-indigo-400">easy-bdc</a>.
        </footer>
    </div>

    <!-- Code Modal -->
    <div id="codeModal" class="modal-overlay fixed inset-0 z-50 hidden justify-center items-center p-4">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-xl max-w-3xl w-full max-h-[90vh] flex flex-col p-6 shadow-2xl">
            <div class="flex justify-between items-center border-b pb-3 mb-4 dark:border-gray-700">
                <h3 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">生成された Python コード</h3>
                <button id="closeModalBtn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <i data-lucide="x" class="w-6 h-6 text-gray-500"></i>
                </button>
            </div>
            
            <div class="flex-grow overflow-hidden relative">
                <pre class="bg-gray-900 text-green-300 p-4 rounded-lg overflow-y-auto max-h-full">
                    <code id="codeOutput" class="text-sm">
                        <!-- Code will be inserted here -->
                    </code>
                </pre>
                <div class="absolute top-4 right-4 flex space-x-2">
                    <button id="copyCodeBtn" class="px-3 py-1 bg-green-500 text-white text-xs font-semibold rounded-lg hover:bg-green-600 transition flex items-center space-x-1">
                        <i data-lucide="copy" class="w-3 h-3"></i>
                        <span>コピー</span>
                    </button>
                </div>
            </div>

            <p class="mt-4 text-sm text-gray-500 dark:text-gray-400">
                このコードは Nextcord/Discord.py V2形式で書かれています。実行には `nextcord` ライブラリのインストールが必要です。
            </p>
        </div>
    </div>

    <script type="module">
        // Lucide icons initialization
        lucide.createIcons();

        // --- State Management and Constants ---
        const INTENTS = [
            { name: 'GUILDS', description: 'サーバーの情報を取得' },
            { name: 'MEMBERS', description: 'メンバーの情報を取得 (要Privileged)' },
            { name: 'BANS', description: 'BAN情報を取得' },
            { name: 'EMOJIS_AND_STICKERS', description: '絵文字とスタンプを取得' },
            { name: 'INTEGRATIONS', description: '連携情報を取得' },
            { name: 'WEBHOOKS', description: 'ウェブフックを取得' },
            { name: 'INVITES', description: '招待情報を取得' },
            { name: 'VOICE_STATES', description: 'ボイスチャンネルの状態を取得' },
            { name: 'PRESENCES', description: 'プレゼンス情報 (活動状況) を取得 (要Privileged)' },
            { name: 'GUILD_MESSAGES', description: 'サーバーでのメッセージ受信' },
            { name: 'GUILD_REACTIONS', description: 'サーバーでのリアクション受信' },
            { name: 'GUILD_MESSAGE_TYPING', description: 'サーバーでのタイピング開始' },
            { name: 'DIRECT_MESSAGES', description: 'DMでのメッセージ受信' },
            { name: 'DIRECT_REACTIONS', description: 'DMでのリアクション受信' },
            { name: 'DIRECT_MESSAGE_TYPING', description: 'DMでのタイピング開始' },
            { name: 'MESSAGE_CONTENT', description: 'メッセージ内容の取得 (V2 Botでのみ必要、要Privileged)' },
            { name: 'SCHEDULED_EVENTS', description: 'スケジュールされたイベントを取得' },
        ];

        let commandCounter = 1;
        
        // --- DOM Elements ---
        const themeToggle = document.getElementById('themeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        const intentsContainer = document.getElementById('intentsContainer');
        const commandsContainer = document.getElementById('commandsContainer');
        const addCommandBtn = document.getElementById('addCommandBtn');
        const downloadXMLBtn = document.getElementById('downloadXMLBtn');
        const showCodeBtn = document.getElementById('showCodeBtn');
        const codeModal = document.getElementById('codeModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const codeOutput = document.getElementById('codeOutput');
        const copyCodeBtn = document.getElementById('copyCodeBtn');

        // --- Helper Functions ---

        /**
         * Get the current state of the application inputs.
         * @returns {object} Application state.
         */
        const getState = () => {
            const projectName = document.getElementById('projectName').value;
            const botToken = document.getElementById('botToken').value;

            // Get selected intents
            const selectedIntents = INTENTS
                .map(intent => ({
                    name: intent.name,
                    checked: document.getElementById(`intent-${intent.name}`).checked
                }))
                .filter(intent => intent.checked)
                .map(intent => intent.name);

            // Get defined commands
            const commands = Array.from(commandsContainer.children)
                .map(commandDiv => {
                    const id = commandDiv.dataset.id;
                    const name = document.getElementById(`command-name-${id}`).value.trim().toLowerCase().replace(/[^a-z0-9_]/g, '');
                    const description = document.getElementById(`command-description-${id}`).value.trim();
                    const response = document.getElementById(`command-response-${id}`).value;
                    return { id, name, description, response };
                })
                .filter(cmd => cmd.name && cmd.description && cmd.response);

            return { projectName, botToken, selectedIntents, commands };
        };

        /**
         * Generates the Python code based on current state.
         * @returns {string} The complete Python code.
         */
        const generatePythonCode = () => {
            const { botToken, selectedIntents, commands } = getState();
            const intentsList = selectedIntents.map(name => `\t\tnextcord.Intents.${name},`).join('\n');
            
            let code = `# Nextcord/Discord.py v2 対応のシンプルなボットコード
# 必要なライブラリ: pip install nextcord

import nextcord
from nextcord.ext import commands
import os

# --- 1. インテント設定 ---
# 必要なインテントのみを有効にしてください。
# Privileged Intents (MEMBERS, PRESENCES, MESSAGE_CONTENT) を使用する場合は、
# Discord開発者ポータルで有効にする必要があります。
intents = nextcord.Intents.none()
intents.default() # デフォルトのインテントを有効化
${intentsList ? `
# ユーザーが選択した追加/上書きインテント
intents.none() # デフォルトを無効化し、選択したものだけを有効化することも可能です
${intentsList}
` : ''}

# --- 2. クライアント設定 ---
# Nextcord/Discord.py V2では、Intentsの明示的な指定が必須です。
bot = commands.Bot(command_prefix='!', intents=intents)

# --- 3. イベントハンドラ ---

@bot.event
async def on_ready():
    # ボットがログインして準備ができたときに呼び出されます
    print(f'ログイン成功! ボット名: {bot.user}')
    print('---')
    # グローバルスラッシュコマンドをすぐに登録したい場合は、
    # 以下のコードのコメントアウトを外してください (テスト用)
    # await bot.sync_all_application_commands() 


# --- 4. スラッシュコマンド定義 ---

# サーバーコマンドとしてテストする場合
@bot.slash_command(name="ping", description="Ping/Pongを返します")
async def ping_command(interaction: nextcord.Interaction):
    await interaction.response.send_message("Pong!")


# ユーザーが定義したスラッシュコマンド
class BotCommands(commands.Cog):
    def __init__(self, bot: commands.Bot):
        self.bot = bot

${commands.map(cmd => `
    @nextcord.slash_command(name="${cmd.name}", description="${cmd.description}")
    async def ${cmd.name}_command(self, interaction: nextcord.Interaction):
        # 応答メッセージ
        await interaction.response.send_message("""
${cmd.response.replace(/\n/g, '\n        ')}
        """)

`).join('')}

# --- 5. ボットの実行 ---

if __name__ == '__main__':
    # Bot Tokenを直接コードに書くことは非推奨です。
    # 環境変数からの読み込みを強く推奨します (例: os.getenv('DISCORD_TOKEN'))
    BOT_TOKEN = "${botToken || 'YOUR_BOT_TOKEN_HERE'}"
    
    # コマンドCogを追加
    bot.add_cog(BotCommands(bot))

    if BOT_TOKEN == "YOUR_BOT_TOKEN_HERE" or not BOT_TOKEN:
        print("\\n!!! エラー: BOT_TOKENが設定されていません。トークンを設定してください。 !!!")
    else:
        try:
            bot.run(BOT_TOKEN)
        except Exception as e:
            print(f"ボットの実行中にエラーが発生しました: {e}")
            print("トークンが正しいか、必要なインテントが有効になっているか確認してください。")
`;

            return code;
        };


        /**
         * Generates the XML content for Bot Designer For Discord.
         * @returns {string} The complete XML content.
         */
        const generateXML = () => {
            const { projectName, botToken, selectedIntents, commands } = getState();

            const xmlCommands = commands.map(cmd => {
                // BD4DのXML形式に合わせて調整
                const safeName = cmd.name;
                const safeDescription = cmd.description.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const safeResponse = cmd.response.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '&#xa;');
                
                return `
        <command name="${safeName}" type="SLASH_COMMAND">
            <description>${safeDescription}</description>
            <content>
                <block type="send_message">
                    <value name="message">
                        <block type="text">
                            <field name="TEXT">${safeResponse}</field>
                        </block>
                    </value>
                </block>
            </content>
        </command>`;
            }).join('\n');

            const xmlIntents = selectedIntents.map(intent => `\n        <intent name="${intent}"/>`).join('');
            
            const xmlContent = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<botproject name="${projectName.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}" version="1.0">
    <settings>
        <token>${botToken}</token>
        <defaultPrefix>!</defaultPrefix>
        <intents>${xmlIntents}
        </intents>
        <options>
            <option name="slashCommandsOnly" value="true"/>
            <option name="prefixCommandsDisabled" value="true"/>
        </options>
    </settings>
    <events>
        <event name="on_ready">
            <content>
                <block type="log">
                    <value name="message">
                        <block type="text">
                            <field name="TEXT">Botが正常に起動しました！</field>
                        </block>
                    </value>
                </block>
            </content>
        </event>
    </events>
    <commands>${xmlCommands}
    </commands>
</botproject>`;
            return xmlContent;
        };

        /**
         * Renders the intent checkboxes.
         */
        const renderIntents = () => {
            intentsContainer.innerHTML = INTENTS.map(intent => `
                <div class="flex items-center">
                    <input id="intent-${intent.name}" type="checkbox" value="${intent.name}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 dark:border-gray-700 dark:bg-gray-700">
                    <label for="intent-${intent.name}" class="ml-2 block text-sm font-medium">
                        ${intent.name}
                        <span class="block text-xs text-gray-500 dark:text-gray-400">${intent.description}</span>
                    </label>
                </div>
            `).join('');

            // 初期選択 (GUILDS, GUILD_MESSAGES, MESSAGE_CONTENT)
            document.getElementById('intent-GUILDS').checked = true;
            document.getElementById('intent-GUILD_MESSAGES').checked = true;
            document.getElementById('intent-MESSAGE_CONTENT').checked = true;
        };

        /**
         * Adds a new command input block.
         * @param {number} id - Unique ID for the command.
         */
        const addCommandInput = (id) => {
            const commandDiv = document.createElement('div');
            commandDiv.dataset.id = id;
            commandDiv.className = 'p-4 border border-gray-200 dark:border-gray-700 rounded-lg space-y-3 bg-gray-50 dark:bg-gray-750';
            commandDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <h4 class="font-medium text-lg">コマンド #${id}</h4>
                    <button data-id="${id}" class="remove-command-btn p-1 text-red-500 hover:text-red-600 transition">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                <div>
                    <label for="command-name-${id}" class="block text-sm font-medium mb-1">コマンド名 (半角英数字, 小文字のみ)</label>
                    <input type="text" id="command-name-${id}" placeholder="例: hello" maxlength="32" 
                        class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>
                <div>
                    <label for="command-description-${id}" class="block text-sm font-medium mb-1">説明</label>
                    <input type="text" id="command-description-${id}" placeholder="例: 挨拶をします" maxlength="100"
                        class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>
                <div>
                    <label for="command-response-${id}" class="block text-sm font-medium mb-1">応答メッセージ</label>
                    <textarea id="command-response-${id}" rows="3" placeholder="ボットが応答するメッセージを入力"
                        class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 focus:ring-indigo-500 focus:border-indigo-500 resize-y transition duration-150"></textarea>
                </div>
            `;
            commandsContainer.appendChild(commandDiv);
            lucide.createIcons();

            // イベントリスナーを再設定
            commandDiv.querySelector('.remove-command-btn').addEventListener('click', (e) => {
                const targetId = e.currentTarget.dataset.id;
                document.querySelector(`div[data-id="${targetId}"]`).remove();
            });

            // コマンド名の入力規制
            document.getElementById(`command-name-${id}`).addEventListener('input', (e) => {
                e.target.value = e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, '');
            });
        };

        // --- Event Handlers ---

        const initializeApp = () => {
            // Theme Toggle
            const isDark = localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDark) {
                document.documentElement.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }

            themeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isDarkMode = document.documentElement.classList.contains('dark');
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                sunIcon.classList.toggle('hidden', isDarkMode);
                moonIcon.classList.toggle('hidden', !isDarkMode);
                lucide.createIcons();
            });

            // Render initial elements
            renderIntents();
            // 初期コマンドを2つ追加
            addCommandInput(commandCounter++);
            addCommandInput(commandCounter++);

            addCommandBtn.addEventListener('click', () => {
                addCommandInput(commandCounter++);
            });

            downloadXMLBtn.addEventListener('click', () => {
                const xmlContent = generateXML();
                const blob = new Blob([xmlContent], { type: 'application/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${document.getElementById('projectName').value || 'BotProject'}.xml`;
                a.click();
                URL.revokeObjectURL(url);
            });

            showCodeBtn.addEventListener('click', () => {
                codeOutput.textContent = generatePythonCode();
                codeModal.classList.remove('hidden');
                codeModal.classList.add('flex');
                setTimeout(() => codeModal.classList.add('show-modal'), 10);
            });

            closeModalBtn.addEventListener('click', () => {
                codeModal.classList.remove('show-modal');
                setTimeout(() => {
                    codeModal.classList.remove('flex');
                    codeModal.classList.add('hidden');
                }, 200);
            });
            
            copyCodeBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(codeOutput.textContent).then(() => {
                    copyCodeBtn.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> コピー完了';
                    lucide.createIcons();
                    setTimeout(() => {
                        copyCodeBtn.innerHTML = '<i data-lucide="copy" class="w-3 h-3"></i> コピー';
                        lucide.createIcons();
                    }, 2000);
                }).catch(err => {
                    console.error('コピーに失敗しました:', err);
                    copyCodeBtn.innerHTML = '<i data-lucide="x" class="w-3 h-3"></i> 失敗';
                    lucide.createIcons();
                    setTimeout(() => {
                        copyCodeBtn.innerHTML = '<i data-lucide="copy" class="w-3 h-3"></i> コピー';
                        lucide.createIcons();
                    }, 2000);
                });
            });
        };

        window.onload = initializeApp;
    </script>
</body>
</html>